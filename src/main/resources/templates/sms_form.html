<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container">
    <h5 class="my-3 border-bottom pb-2 bg-light p-2 rounded">SMS ì „ì†¡</h5>
    <h6 class="my-3 pb-2 text-secondary">â–¶ ìˆ˜ì‹  ëŒ€ìƒ ì„ íƒ</h6>
    <table class="table" id="mainTable">
        <thead class="table">
        <tr class="text-center">
            <th>
                <input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes(this)">
            </th>
            <th>ë²ˆí˜¸</th>
            <th >ì‚¬ìš©ì ì•„ì´ë””</th>
            <th>í•¸ë“œí°ë²ˆí˜¸</th>
            <th>ì´ë©”ì¼</th>
        </tr>
        </thead>
        <tbody>
        <tr class="text-center" th:each="user, stat : ${user}">
            <td>
                <input type="checkbox" class="userCheckbox">
            </td>
            <td th:text="${stat.count}"></td>
            <td user-id><span th:text="${user.username}"></span></td>
            <td data-phone><span th:if="${user.phoneNumber != null}" th:text="${user.phoneNumber}"></span></td>
            <td><span th:if="${user.email != null}" th:text="${user.email}"></span></td>
        </tr>
        </tbody>
    </table>
    <button onclick="moveCheckedRows()" class="btn btn-primary my-2">ì„ íƒ ì¶”ê°€</button>
    <br>
    <br>
    <h6 class="my-3 pb-2 text-secondary">â–¶ ìˆ˜ì‹  ëŒ€ìƒ</h6>
    <table class="table" id="selectedTable">
        <thead class="table">
        <tr class="text-center">
            <th>
                <input type="checkbox" id="selectSelectedAll" onclick="toggleAllSelectedCheckboxes(this)">
            </th>
            <th>ë²ˆí˜¸</th>
            <th >ì‚¬ìš©ì ì•„ì´ë””</th>
            <th>í•¸ë“œí°ë²ˆí˜¸</th>
            <th>ì´ë©”ì¼</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <button onclick="removeCheckedRows()" class="btn btn-primary my-2">ì„ íƒ ì‚­ì œ</button>
    <br>
    <br>
    <h6 class="my-3 pb-2 text-secondary">â–¶ ë°œì†¡ ë‚´ìš©</h6>
    <form th:object="${smsForm}" method="post" onsubmit="addSelectedNumbers(event)">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <div th:replace="~{form_errors :: formErrorsFragment}"></div>

        <div class="mb-3">
            <label for="messageContent" class="form-label">ë‚´ìš©</label>
            <textarea id="messageContent" th:field="*{messageContent}" class="form-control" rows="10"></textarea>
        </div>
        <span id="byte">0</span><span> / 90 byte</span>

        <br>
        <br>

        <!-- ì²´í¬ëœ ì „í™”ë²ˆí˜¸ -->
        <input type="hidden" name="selectedNumbers" id="selectedNumbers">

        <div class="mb-3">
            <label for="senderPhoneNumber" class="form-label">íšŒì‹ ë²ˆí˜¸</label>
            <input type="text" id="senderPhoneNumber" th:field="*{senderPhoneNumber}" class="form-control" pattern="\d{3}-\d{4}-\d{4}" placeholder="010-1234-5678">
        </div>

        <!-- ë°œì†¡ ìœ í˜• ì„ íƒ + ì˜ˆì•½ ì‹œê°„ (ê°€ë¡œ ì •ë ¬) -->
        <div class="mb-5">
            <label class="form-label">ë°œì†¡ ìœ í˜•</label>

            <div class="d-flex align-items-center">
                <!-- ì¦‰ì‹œ ë°œì†¡ -->
                <div class="form-check me-5">
                    <input type="radio" th:field="*{sendType}" id="immediate" value="immediate" class="form-check-input" checked onclick="toggleReserve(false)">
                    <label for="immediate" class="form-check-label">ì¦‰ì‹œ ë°œì†¡</label>
                </div>

                <!-- ì˜ˆì•½ ë°œì†¡ -->
                <div class="form-check me-3">
                    <input type="radio" th:field="*{sendType}" id="reserve" value="reserve" class="form-check-input" onclick="toggleReserve(true)">
                    <label for="reserve" class="form-check-label">ì˜ˆì•½ ë°œì†¡</label>
                </div>

                <!-- ì˜ˆì•½ ì‹œê°„ ì…ë ¥ (ì˜ˆì•½ ë°œì†¡ ì„ íƒ ì‹œë§Œ í‘œì‹œ) -->
                <div id="sendTimeContainer" class="ms-3" style="display: none;">
                    <input type="datetime-local" th:field="*{sendTime}" class="form-control">
                </div>
            </div>
        </div>
        <input type="submit" value="ì „ì†¡í•˜ê¸°" class="btn btn-primary my-2">
    </form>

    <br>
    <br>
</div>
<script layout:fragment="script" type='text/javascript'>
    // âœ… ìˆ˜ì‹  ëŒ€ìƒ ì „ì²´ ì„ íƒ
    function toggleAllCheckboxes(source) {
        let checkboxes = document.querySelectorAll(".userCheckbox");
        checkboxes.forEach(checkbox => {
            checkbox.checked = source.checked;
        });
    }

    // âœ… ì„ íƒëœ ìˆ˜ì‹  ëŒ€ìƒ ì „ì²´ ì„ íƒ
    function toggleAllSelectedCheckboxes(source) {
        let checkboxes = document.querySelectorAll(".selectedCheckbox");
        checkboxes.forEach(checkbox => {
            checkbox.checked = source.checked;
        });
    }



    // âœ… ë°œì†¡ ì‹œ ì„ íƒëœ ìˆ˜ì‹  ëŒ€ìƒ ì²˜ë¦¬
    function addSelectedNumbers(event) {
        event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€ (ì²´í¬ëœ ê°’ì„ ë¨¼ì € ì„¤ì •)

        let selectedNumbers = [];
        let checkboxes = document.querySelectorAll(".selectedCheckbox:checked");

        checkboxes.forEach(checkbox => {
            let phoneCell = checkbox.closest("tr").querySelector("td[data-phone] span");
            if (phoneCell) {
                let phoneNumber = phoneCell.textContent.trim();
                if (phoneNumber) {
                    selectedNumbers.push(phoneNumber);
                }
            }
        });

        // 1ï¸âƒ£ ìˆ˜ì‹  ëŒ€ìƒìê°€ ì—†ëŠ” ê²½ìš°
        if (selectedNumbers.length === 0) {
            alert("ë°œì†¡í•  ìˆ˜ì‹ ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // 2ï¸âƒ£ ë°œì†¡ ë‚´ìš©ì´ ì…ë ¥ë˜ì§€ ì•Šì€ ê²½ìš°
        let messageContent = document.getElementById("messageContent").value.trim();
        if (!messageContent) {
            alert("ë°œì†¡ë‚´ìš©ì„ ì…ë ¥í•˜ì—¬ ì£¼ì„¸ìš”.");
            return;
        }

        // 3ï¸âƒ£ íšŒì‹ ë²ˆí˜¸ê°€ ì—†ëŠ” ê²½ìš°
        let replyNumber = document.getElementById("senderPhoneNumber").value.trim();
        if (!replyNumber) {
            alert("íšŒì‹ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤. íšŒì‹ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

         // 4ï¸âƒ£ ì˜ˆì•½ë°œì†¡ì¼ì´ í˜„ì¬ ë‚ ì§œë³´ë‹¤ ì´ì „ì´ê±°ë‚˜ ê°™ì€ ê²½ìš°
        let scheduledDate = document.querySelector("#sendTimeContainer input[type='datetime-local']").value;

        if (scheduledDate) {
            let selectedDateTime = new Date(scheduledDate); // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì˜ˆì•½ ì‹œê°„
            let currentDateTime = new Date(); // í˜„ì¬ ë‚ ì§œ ë° ì‹œê°„

            if (selectedDateTime <= currentDateTime) {
                alert("ì˜ˆì•½ë°œì†¡ì¼ì€ í˜„ì¬ì¼ ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
        }

        // ğŸ“Œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µê³¼í•œ ê²½ìš° ìµœì¢… í™•ì¸
        if (!confirm("ë°œì†¡ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
        }


        // ğŸ“Œ ìœ íš¨í•œ ìˆ˜ì‹ ì ëª©ë¡ì„ input í•„ë“œì— ì €ì¥
        document.getElementById("selectedNumbers").value = selectedNumbers.join(",");
        // selectedNumbers ë°°ì—´ì˜ ê°’ë“¤ì„ ì‰¼í‘œ(,)ë¡œ ì—°ê²°í•˜ì—¬ ë¬¸ìì—´ë¡œ ë§Œë“  ë’¤, id="selectedNumbers" ì¸ <input> íƒœê·¸ì˜ ê°’ìœ¼ë¡œ ì„¤ì •


        event.target.submit(); // ğŸ“Œìˆ˜ì •ëœ ê°’ê³¼ í•¨ê»˜ í¼ ì œì¶œ
    }




    // âœ… ì˜ˆì•½ ì „ì†¡ ì‹œ
    function toggleReserve(show) {
        document.getElementById("sendTimeContainer").style.display = show ? "block" : "none";
    }

    // âœ… ì„ íƒ ì¶”ê°€ ê¸°ëŠ¥
    function moveCheckedRows() {
        const mainTable = document.getElementById("mainTable");
        const selectedTable = document.getElementById("selectedTable").getElementsByTagName("tbody")[0];
        let isEssential = false; // íœ´ëŒ€ì „í™” ì •ë³´ê°€ ì—†ëŠ” ì‚¬ìš©ìê°€ ìˆëŠ”ì§€ í™•ì¸

        document.querySelectorAll("#mainTable .userCheckbox:checked").forEach(checkbox => {
            let row = checkbox.closest("tr");

            let userIdElement = row.querySelector("td[user-id] span");
            let userId = userIdElement.innerText;

            // ğŸ“Œ ìœ íš¨ì„± ê²€ì‚¬ : í•¸ë“œí° ë²ˆí˜¸ê°€ ìˆëŠ”ì§€ í™•ì¸
            let phoneElement = row.querySelector("td[data-phone] span");
            let phoneNumber = phoneElement ? phoneElement.innerText.trim() : "";

            if (!phoneNumber) {
                isEssential = true; // íœ´ëŒ€ì „í™” ì •ë³´ ì—†ëŠ” ì‚¬ìš©ì ë°œê²¬
                return; // ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            }

            // ğŸ“Œ ì¤‘ë³µ í™•ì¸ (user-id ì†ì„± ê¸°ë°˜)
            if ([...selectedTable.rows].some(r => r.querySelector("td[user-id] span")?.innerText === userId)) {
                return; // ì¤‘ë³µ ë°©ì§€
            }

            let newRow = selectedTable.insertRow();
            newRow.setAttribute("class", "text-center");

            let newCell = newRow.insertCell();
            newCell.innerHTML = '<input type="checkbox" class="selectedCheckbox" checked>';

            for (let i = 1; i < row.cells.length; i++) {
                let newCell = newRow.insertCell();
                newCell.innerHTML = row.cells[i].innerHTML;

                 // ğŸ“Œ í•¸ë“œí°ë²ˆí˜¸ ì¹¸ì¸ ê²½ìš° data-phone ì†ì„± ì¶”ê°€
                if (row.cells[i].hasAttribute("data-phone")) {
                    newCell.setAttribute("data-phone", "");
                }

                // ğŸ“Œ ì‚¬ìš©ì ì•„ì´ë”” ì¹¸ì¸ ê²½ìš° user-id ì†ì„± ì¶”ê°€
                if (row.cells[i].hasAttribute("user-id")) {
                    newCell.setAttribute("user-id", "");
                }
            }
        });

        document.querySelectorAll("#mainTable .userCheckbox:checked").forEach(checkbox => {
            checkbox.checked = false;
        });

        // ğŸ“Œ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ ê²½ê³  ë©”ì‹œì§€ ì¶œë ¥
        if (isEssential) {
            alert("íœ´ëŒ€ì „í™” ì •ë³´ê°€ ë“±ë¡ë˜ì§€ ì•Šì€ ê³ ê°ì€ ì¶”ê°€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    }

    // âœ… ì„ íƒ ì‚­ì œ
    function removeCheckedRows() {
        document.querySelectorAll("#selectedTable .selectedCheckbox:checked").forEach(checkbox => {
            checkbox.closest("tr").remove();
        });
    }


    // âœ… ë¬¸ìì—´ì˜ EUC-KR ë°”ì´íŠ¸ ê¸¸ì´ ê³„ì‚° í•¨ìˆ˜
    function getByteLength(str) {
        let byteLength = 0;
        for (let i = 0; i < str.length; i++) {
            let charCode = str.charCodeAt(i);
            if (charCode < 0x80) {
                byteLength += 1; // ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ë“± 1ë°”ì´íŠ¸
            } else {
                byteLength += 2; // í•œê¸€ ë“± 2ë°”ì´íŠ¸
            }
        }
        return byteLength;
    }

    // âœ… ì‹¤ì‹œê°„ ë°”ì´íŠ¸ ìˆ˜ ì—…ë°ì´íŠ¸
    function updateByteCount() {
        let messageContent = document.getElementById("messageContent");
        let byteSpan = document.getElementById("byte");
        let maxByte = 90;

        let currentByte = getByteLength(messageContent.value);

        if (currentByte > maxByte) {
            alert("ì…ë ¥ ê°€ëŠ¥í•œ ìµœëŒ€ ë°”ì´íŠ¸(90)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.");
            messageContent.value = messageContent.value.slice(0, -1); // ë§ˆì§€ë§‰ ì…ë ¥ ì œê±°
            currentByte = getByteLength(messageContent.value); // ë‹¤ì‹œ ê³„ì‚°
        }

        byteSpan.textContent = currentByte;
    }

    // âœ… ì‚¬ìš©ìê°€ ì…ë ¥í•  ë•Œë§ˆë‹¤ updateByteCountë¼ëŠ” í•¨ìˆ˜ë¥¼ ì‹¤í–‰
    document.addEventListener("DOMContentLoaded", function () {
        let messageContent = document.getElementById("messageContent");
        messageContent.addEventListener("input", updateByteCount);
    });

</script>
</html>