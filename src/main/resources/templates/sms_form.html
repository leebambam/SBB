<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container">
    <h5 class="my-3 border-bottom pb-2 bg-light p-2 rounded">SMS 전송</h5>
    <h6 class="my-3 pb-2 text-secondary">▶ 수신 대상 선택</h6>
    <table class="table">
        <thead class="table">
        <tr class="text-center">
            <th>
                <input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes(this)">
            </th>
            <th>번호</th>
            <th >사용자 아이디</th>
            <th>핸드폰번호</th>
            <th>이메일</th>
        </tr>
        </thead>
        <tbody>
        <tr class="text-center" th:each="user, stat : ${user}">
            <td>
                <input type="checkbox" class="userCheckbox">
            </td>
            <td th:text="${stat.count}"></td>
            <td><span th:text="${user.username}"></span></td>
            <td data-phone><span th:if="${user.phoneNumber != null}" th:text="${user.phoneNumber}"></span></td>
            <td><span th:if="${user.email != null}" th:text="${user.email}"></span></td>
        </tr>
        </tbody>
    </table>

    <br>
    <h6 class="my-3 pb-2 text-secondary">▶ 발송 내용</h6>
    <form th:object="${smsForm}" method="post" onsubmit="addSelectedNumbers(event)">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <div th:replace="~{form_errors :: formErrorsFragment}"></div>

        <div class="mb-3">
            <label for="messageContent" class="form-label">내용</label>
            <textarea id="text" th:field="*{messageContent}" class="form-control" rows="10"></textarea>
        </div>

        <!-- 체크된 전화번호 -->
        <input type="hidden" name="selectedNumbers" id="selectedNumbers">

        <div class="mb-3">
            <label for="senderPhoneNumber" class="form-label">회신번호</label>
            <input type="text" th:field="*{senderPhoneNumber}" class="form-control" pattern="\d{3}-\d{4}-\d{4}" placeholder="010-1234-5678">
        </div>

        <input type="submit" value="전송하기" class="btn btn-primary my-2">
    </form>
</div>
<script layout:fragment="script" type='text/javascript'>
    function toggleAllCheckboxes(source) {
        let checkboxes = document.querySelectorAll(".userCheckbox");
        checkboxes.forEach(checkbox => {
            checkbox.checked = source.checked;
        });
    }

    function addSelectedNumbers(event) {
        event.preventDefault(); // 폼 제출 방지 (체크된 값을 먼저 설정)

        let selectedNumbers = [];
        let checkboxes = document.querySelectorAll(".userCheckbox:checked");
        // .userCheckbox 클래스의 체크박스들을 모두 선택

        checkboxes.forEach(checkbox => {
            let phoneCell = checkbox.closest("tr").querySelector("td[data-phone] span");
            if (phoneCell) {
                let phoneNumber = phoneCell.textContent.trim();
                if (phoneNumber) {
                    selectedNumbers.push(phoneNumber);
                }
            }
        });

        document.getElementById("selectedNumbers").value = selectedNumbers.join(",");
        // selectedNumbers 배열의 값들을 쉼표(,)로 연결하여 문자열로 만든 뒤, id="selectedNumbers" 인 <input> 태그의 값으로 설정

        event.target.submit(); // 수정된 값과 함께 폼 제출
    }
</script>
</html>